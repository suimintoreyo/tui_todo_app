# JSONデータベース TUI スケジュール管理ソフト — 技術仕様書

## 1. プロジェクト概要

JSON ファイルをデータベースとして使用する TUI（Terminal User Interface）ベースのスケジュール管理アプリケーション。
メイン画面に月カレンダーとスケジュール詳細の2ペインレイアウトを配置し、日付選択でスケジュール詳細を表示する。
キーボード操作によりスケジュールの追加・編集・削除・検索を行える。

---

## 2. 技術スタック

| 項目 | 技術 |
|---|---|
| 言語 | Python 3.10+ |
| TUI フレームワーク | Textual (>=1.0.0) |
| データストア | JSON ファイル |
| データモデル | dataclass |
| バックアップ | 書き込み時に `.bak` 自動生成 |
| テスト | pytest |

---

## 3. データ構造

### 3.1 スケジュールレコード

```json
{
  "id": "a1b2c3d4",
  "date_time": "250614_1430",
  "date_time_type": "exact",
  "title": "チームミーティング",
  "memo": "議題: Q3計画",
  "created_at": "250613_0900"
}
```

| フィールド | 型 | 説明 |
|-----------|------|------|
| `id` | string | UUID の先頭8文字（自動生成） |
| `date_time` | string | 日時（`YYMMDD_HHMM` 形式、タイプ修飾子付き） |
| `date_time_type` | string | `exact` / `until` / `from` |
| `title` | string | スケジュール名（必須） |
| `memo` | string | メモ（空文字列可） |
| `created_at` | string | 作成日時（`YYMMDD_HHMM` 形式、自動記録） |

### 3.2 日時フォーマット

- **基本表記**: `YYMMDD_HHMM`（例: `250614_1430` → 2025年6月14日 14:30）
  - `YY` — 年（下2桁）
  - `MM` — 月（2桁）
  - `DD` — 日（2桁）
  - `HH` — 時（24時間表記）
  - `MM` — 分（2桁）
- **指定時間まで（until）**: `~YYMMDD_HHMM`（例: `~250614_1430` → 2025年6月14日 14:30 まで）
- **指定時間以降（from）**: `YYMMDD_HHMM~`（例: `250614_1430~` → 2025年6月14日 14:30 以降）

### 3.3 JSON ファイル構成

```
data/
├── schedules.json       # スケジュールデータ本体
├── schedules.json.bak   # 自動バックアップ（書き込み時に前回内容を保存）
└── config.json          # アプリ設定
```

`schedules.json` の構造:

```json
{
  "schedules": [
    {
      "id": "a1b2c3d4",
      "date_time": "250614_1430",
      "date_time_type": "exact",
      "title": "チームミーティング",
      "memo": "議題: Q3計画",
      "created_at": "250613_0900"
    }
  ]
}
```

---

## 4. 機能一覧

### 4.1 スケジュール登録

入力フォーム（モーダル）で以下の項目を入力:

| 入力項目 | 必須 | 入力形式 | 説明 |
|---|---|---|---|
| 日付 | ○ | `YYMMDD`（6桁） | 年2桁 + 月2桁 + 日2桁 |
| 時刻 | ○ | `HHMM`（4桁） | 時2桁 + 分2桁（24時間制） |
| タイプ | ○ | Select | 「指定時刻」「～まで」「～以降」 |
| タイトル | ○ | テキスト | スケジュール名称 |
| メモ | — | テキスト | 自由記述 |

- 登録時に `created_at` を自動付与（`YYMMDD_HHMM` 形式）
- `id` は UUID 先頭8文字を自動生成

### 4.2 スケジュール確認

- カレンダー上の日付を選択 → 該当日のスケジュール一覧を詳細ビューに時刻順で表示
- 詳細ビューに表示する項目:
  - 時刻（タイプ表記含む: `14:30` / `~14:30` / `14:30~`）
  - タイトル
  - メモ（存在する場合）
- スケジュールが無い場合は「スケジュールなし」を表示

### 4.3 スケジュール編集

- 詳細ビューでスケジュールを選択し `e` キーで編集フォームを表示
- 現在の値がフォームに入力済みの状態で表示
- 日付を変更した場合、保存後に変更先の日付に自動移動

### 4.4 スケジュール削除

- 詳細ビューでスケジュールを選択し `d` キーで確認ダイアログを表示
- 「はい」で削除、「いいえ」でキャンセル

### 4.5 検索

- `/` キーで検索ダイアログを表示
- タイトルまたはメモにキーワードを含むスケジュールを検索（大文字・小文字区別なし）
- 結果が見つかった場合、最初のスケジュールの日付に自動移動
- 結果件数を通知表示

---

## 5. 表示 UI 設計

### 5.1 全体レイアウト

```
┌─────────────────────────────────────────────────────────────────┐
│                    JSON スケジュール管理                        │  ← ヘッダー
├──────────────────────────────┬──────────────────────────────────┤
│                              │                                  │
│     ◀  2026年02月  ▶        │  ── 2026/02/19 ──               │
│                              │                                  │
│  Mon Tue Wed Thu Fri Sat Sun │    10:00  チームミーティング     │
│                          1   │           memo: Q1計画策定       │
│    2   3   4   5   6   7  8  │                                  │
│    9  10  11  12  13  14  15 │    14:30  コードレビュー         │
│   16  17  18 [19] 20  21  22 │           memo: PR #123          │
│   23  24  25  26  27  28     │                                  │
│                              │    18:00~ 外出                   │
│   ● = スケジュールあり       │           memo: 渋谷方面         │
│                              │                                  │
│  左ペイン: カレンダー        │  右ペイン: スケジュール詳細      │
├──────────────────────────────┴──────────────────────────────────┤
│ a:追加  e:編集  d:削除  /:検索  t:今日  </>:月切替  Tab:切替   │  ← フッター
│                                                        q:終了  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 画面構成

| 領域 | 高さ | 内容 |
|------|------|------|
| ヘッダー | 3行 | アプリタイトル（中央揃え、太字、アクセントカラー背景） |
| メインエリア | 可変 | 左右分割: CalendarView + DetailView |
| フッター | 3行 | キーバインド一覧（中央揃え、アクセントカラー背景） |

### 5.3 月カレンダー View

- 月ナビゲーションボタン（◀ ▶）で前月・翌月に移動
- 曜日ヘッダー（Mon〜Sun）をグリッド表示
- 各日付はセル（DayCell）で表示:
  - スケジュールが存在する日には `●` マーカーを表示
  - 今日の日付はハイライト（太字、警告色）
  - 選択中の日付は背景色で強調
  - スケジュールあり日は成功色で表示
- 日付をクリック、または Enter キーで選択 → 右ペインの詳細が連動更新

### 5.4 スケジュール詳細 View

- 選択された日付のスケジュールを時刻順にリスト表示（ListView）
- 各スケジュールの表示内容:
  - **時刻**: タイプに応じた表記（`14:30` / `~14:30` / `14:30~`）+ タイトル
  - **メモ**: `memo: ...` 形式（メモがある場合のみ）
- スケジュールが無い場合は「スケジュールなし」を表示
- リスト内でカーソル移動可能（編集・削除対象の選択用）

---

## 6. キーバインド

| キー | アクション | 説明 |
|---|---|---|
| `a` | add_schedule | スケジュール追加フォームを表示 |
| `e` | edit_schedule | 選択中のスケジュールを編集 |
| `d` | delete_schedule | 選択中のスケジュールを削除（確認付き） |
| `/` | search | 検索ダイアログを表示 |
| `t` | go_today | 今日の日付に移動 |
| `<` | prev_month | 前月に移動 |
| `>` | next_month | 翌月に移動 |
| `Tab` | toggle_focus | カレンダー ↔ 詳細ビュー フォーカス切替 |
| `q` | quit_app | アプリケーション終了 |
| `Enter` | — | カレンダーで日付選択確定 |
| `↑` `↓` | — | スケジュール一覧の選択移動 |
| `Esc` | cancel | フォーム・ダイアログを閉じる |

---

## 7. ファイル構成

```
tui_todo_app/
├── main.py                  # エントリポイント
├── app.py                   # Textual App クラス（メインコントローラ）
├── requirements.txt         # 依存パッケージ（textual>=1.0.0）
├── .gitignore               # __pycache__, .pyc, .venv, .bak 除外
├── db/
│   ├── __init__.py
│   ├── store.py             # JSON 読み書き・バックアップ
│   ├── query.py             # 検索・フィルタ・ソートエンジン
│   └── schema.py            # バリデーション
├── models/
│   ├── __init__.py
│   └── schedule.py          # Schedule データモデル（dataclass）
├── ui/
│   ├── __init__.py
│   ├── calendar_view.py     # 月カレンダー Widget（DayCell含む）
│   ├── detail_view.py       # スケジュール詳細 Widget（ScheduleItem含む）
│   ├── schedule_form.py     # 追加・編集フォーム / 確認ダイアログ / 検索ダイアログ（モーダル）
│   └── header_footer.py     # ヘッダー・フッター Widget
├── utils/
│   ├── __init__.py
│   ├── datetime_util.py     # YYMMDD_HHMM パーサー・フォーマッター
│   └── backup.py            # バックアップ管理
├── tests/
│   ├── __init__.py
│   ├── test_schedule.py     # Schedule モデルのテスト
│   ├── test_store.py        # JSON 読み書きのテスト
│   ├── test_query.py        # 検索・フィルタのテスト
│   ├── test_schema.py       # バリデーションのテスト
│   ├── test_datetime_util.py # 日時パーサーのテスト
│   └── test_backup.py       # バックアップのテスト
├── data/
│   ├── schedules.json       # スケジュールデータ
│   └── config.json          # アプリ設定
├── USER_MANUAL.md           # ユーザマニュアル
└── jsondb-tui-schedule-spec.md  # 本仕様書
```
